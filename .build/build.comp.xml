<?xml version="1.0" encoding="UTF-8"?>
<project name="RSG2_Component" default="buildComponent">
	<description>
		--- RSGallery2 component build script with phing ---
	
		The script 2 copies the component files from path
		RSGallery2_J4\ and creates a build in folder
		..\.packages\tmp. It replaces or changes
		text in files. Then these files are zipped

		All paths start at the build folder. Changes
		are done in the copied files. Use command
		"phing -f updateProject.xml" before to
		standardize all files of the project

		Changes in files
		* Version and date for copyright in *.php files
		* Build ID (file) will be increased and used in version string
		*
		* (Set lines with @since to actual date in *.php)
		*
		* .
		* .

		command line
		phing -logfile .\build.comp.log  -f .\build.comp.xml
	</description>

	<!-- 
	.........................................................................
	ToDo:
	.........................................................................
	* build number
	*
	* Patch: Set lines with @since to actual date in *.php
		<author>[AUTHOR]</author>
		<authorEmail>[AUTHOR_EMAIL]</authorEmail>
		<authorUrl>[AUTHOR_URL]</authorUrl>
	*
	* .
	* .
	* .
	* .
	-->

	<!--
	=========================================================================
	   include libraries
	=========================================================================
	-->

	<import file="build.libMath.xml"/>
	<import file="build.libBuildNumber.xml"/>

	<import file="build.libGeneral.xml" />

	<!--
	=========================================================================
	   Parameter
	=========================================================================
	-->

	<!-- 
	.........................................................................
	Version number of build
	.........................................................................	
	-->
	
    <!-- Version number of build -->
    <property name="build.version" value="5.0.0.4"  />
	    <!-- additional naming postfix -->
    <!--property name="build.postfix" value="prepare." override="true" /-->
    <property name="build.postfix" value="" />

	<!-- 
	.........................................................................
	
	.........................................................................	
	-->
	
    <property name="type" value="component" override="true" />
    <property name="comp_name" value="rsgallery2" override="true" />
	<property name="extension" value="RSGallery2" />

<!--	<php function="strtolower" returnProperty="extensionLower">-->
<!--		<param value="${extension}" />-->
<!--	</php>-->

	<!--
	.........................................................................
	external parameter
	.........................................................................
	-->
	<!-- Not delete of item, no exit message -->
	<property name="isCalledByPackage" value="0" override="true" />
	<property name="buildPackageDir" value="??? PackageDir" override="true" />
	<!-- Not add date in zip name -->
	<property name="isNoDateInZipName" value="0" override="true" />

	<!--
	.........................................................................
	date stamps
	.........................................................................
	-->
	
    <!-- Get the standard date for build -->
    <!-- tstamp prefix="build.date" /-->

	<tstamp>
		<format property="dateYearMonthDay" pattern="%Y%m%d" />
	</tstamp>
	
	<tstamp>
		<format property="date.year.month.day" pattern="%Y.%m.%d" />
	</tstamp>
	
	<tstamp>
		<format property="date.day.month.year" pattern="%d. %b. %Y" />
	</tstamp>
	
	<tstamp>
		<format property="date.year" pattern="%Y" />
	</tstamp>
	
	
	<!-- 
	.........................................................................
	folders
	.........................................................................
	-->
	
    <!-- Declare Project src files -->
    <property name="srcRoot" value="./../../RSGallery2_J4/" override="true" />

    <!-- Set the source and destination directory for copy (sources relative to the build dir) -->
    <property name="buildDir" value="./../.packages/" />
    <property name="buildDirTemp" value="${buildDir}tmp/" override="true" />
	
    <property name="adminComponent" value="administrator/components/com_${comp_name}/" override="true" />
    <property name="siteComponent" value="/components/com_${comp_name}/" override="true" />
    <property name="media" value="/media/com_${comp_name}/" override="true" />
	
    <property name="srcAdminCmp" value="${srcRoot}${adminComponent}/" override="true" />
    <property name="srcSiteCmp" value="${srcRoot}${siteComponent}/" override="true" />
    <property name="srcMediaCmp" value="${srcRoot}${media}/" override="true" />

	<property name="srcBuildNumberFile" value="${srcAdminCmp}/buildNumber.txt" override="true" />

	<property name="dstAdminCmp" value="${buildDirTemp}${adminComponent}/" override="true" />
    <property name="dstSiteCmp" value="${buildDirTemp}${siteComponent}/" override="true" />
    <property name="dstMediaCmp" value="${buildDirTemp}${media}/" override="true" />

	<property name="dstManifestFileName" value="${comp_name}.xml" override="true" />
	<property name="dstManifestFile" value="${buildDirTemp}/${dstManifestFileName}" override="true" />
	<property name="dstAdminManifestFile" value="${dstAdminCmp}/${dstManifestFileName}" override="true" />

	<!--
	.........................................................................
	source file sets
	.........................................................................
	-->
	
    <!-- File set administrator folder -->
    <fileset dir="${srcAdminCmp}" id="adminSet">
        <include name="**" />
		<!-- 2019.10.31 may be accidentally copied from installation server 
        <exclude name="changelog.xml" />
        <exclude name="install.rsgallery2.php" />
        <exclude name="rsgallery2.xml" /-->
    </fileset>

    <!-- File set site folder -->
    <fileset dir="${srcSiteCmp}" id="siteSet">
        <include name="**" />
        <exclude name="**/params.ini" />
    </fileset>

    <!-- File set media folder -->
    <fileset dir="${srcMediaCmp}" id="mediaSet">
        <include name="**" />
    </fileset>

<!--
=========================================================================
   Targets
=========================================================================
-->

<!--	<target name="build" depends="prepareSrcFolder, copy2Temp, -->
<!--	                              manifestFile, zipFiles,-->
<!--								  deleteTemp">-->
	<target name="buildComponent">

		<!-- 
		* prepareSrcFolder
		* incrementBuildNumber
		* copy2Temp
		* versionWithBuildNumber
		* doPatchComponent
		* manifestFile
		* zipFiles
		* .
		-->
		
		<!--phingcall target="bar">
			<property name="property1" value="aaaaa" />
			<property name="foo" value="baz" />
		</phingcall-->

		<echo msg="cmp:build start" />

		<echo msg="   comp_name='${comp_name}'" />

		<echo msg="   isCalledByPackage='${isCalledByPackage}'" />

		<if>
			<!-- on package no timestamp -->
			<equals arg1="${isCalledByPackage}" arg2="0" />
			<then>
				<echo msg="    direct call" />
			</then>
			<else>
				<echo msg="    package call" />
			</else>
		</if>

		<phingcall target="prepareSrcFolder">
		</phingcall>

		<phingcall target="incrementBuildNumber">
		</phingcall>

		<phingcall target="copy2Temp">
		</phingcall>

		<phingcall target="versionWithBuildNumber">
		</phingcall>

		<phingcall target="doPatchComponent">
		</phingcall>

		<!-- Retrieve changed version number ................................. -->

		<loadfile property="newVersion" file="${dstManifestFile}" >
			<filterchain>
				<!-- find line-->
				<linecontainsregexp>
					<regexp pattern="&lt;version&gt;(.*)&lt;" />
				</linecontainsregexp>
				<!-- extract version-->
				<replaceregexp>
					<regexp pattern="(.*&lt;version&gt;)(.*)(&lt;&#47;version&gt;)" replace="\2" />
				</replaceregexp>
				<striplinebreaks />
			</filterchain>
		</loadfile>
		<echo msg="newVersion: ${newVersion}" />
		<!-- ................................................................	-->

		<phingcall target="manifestFile">
		</phingcall>

		<phingcall target="zipFiles">
		</phingcall>

		<!--		<echo msg="   ??? isCalledByPackage='${isCalledByPackage}' ???" />-->

		<!-- Not called external, do clean up  -->
		<if>
			<equals arg1="${isCalledByPackage}" arg2="0" />
			<then>

				<!-- clean / tidy build artefacts -->
				<phing phingfile="build.clean_up.xml">
					<!-- sub task called by package -->
					<property name="buildDirTemp" value="${buildDirTemp}" />
				</phing>

			</then>
		</if>

		<echo msg="cmp:build done" />
		
	</target>

	<!--
    =========================================================================
       SUB - Targets
    =========================================================================
    -->

	<!--
	.........................................................................
	prepareSrcFolder
	.........................................................................
	-->

	<target name="prepareSrcFolder">
		<echo msg="prepareSrcFolder start" />

		<!-- On source path not existing -->
        <mkdir dir="${srcAdminCmp}" />
        <mkdir dir="${srcSiteCmp}" />
        <mkdir dir="${srcMediaCmp}" />
        <!-- mkdir dir="${buildDir}/tmp/plugins" / -->
		
        <echo msg="prepareSrcFolder end" />
    </target>

	<!--
	.........................................................................
	incrementBuildNumber
	.........................................................................
	-->

	<target name="incrementBuildNumber">
		<echo msg="      incrementBuildNumber start" />

		<phingcall target="lib_incrementBuildNumber">
			<property name="buildNumberFile" value="${srcBuildNumberFile}" />
		</phingcall>

		<loadfile property="newBuildNbr" file="${srcBuildNumberFile}">
			<filterchain>
				<striplinebreaks />
			</filterchain>
		</loadfile>
		<echo msg="newBuildNbr: ${newBuildNbr}" />

		<property name="buildNumber" value="${newBuildNbr}"  override="true" />

		<echo msg="outer buildNumber: ${buildNumber}" />

		<echo msg="      incrementBuildNumber end" />
	</target>

	<!--
	.........................................................................
	versionWithBuildNumber
	.........................................................................
	-->

	<target name="versionWithBuildNumber">
		<echo msg="      versionWithBuildNumber start" />

		<!-- Retrieve actual build number ................................. -->

		<loadfile property="newBuildNbr" file="${srcBuildNumberFile}">
			<filterchain>
			    <striplinebreaks />
			</filterchain>
		</loadfile>
		<echo msg="newBuildNbr: ${newBuildNbr}" />

		<!-- Retrieve previous version number ................................. -->

		<loadfile property="versionFound" file="${dstManifestFile}" >
			<filterchain>
				<!-- find line -->
				<linecontainsregexp>
					<regexp pattern="&lt;version&gt;(.*)&lt;" />
				</linecontainsregexp>
				<stripwhitespace />
				<!-- extract version -->
				<replaceregexp>
					<regexp pattern="(.*&lt;version&gt;)(.*)(&lt;&#47;version&gt;)" replace="\2" />
				</replaceregexp>
				<striplinebreaks />
			</filterchain>
		</loadfile>
		<echo msg="   versionFound: '${versionFound}'" />

		<!-- replace __BUMP_VERSION__ if found ................................. -->

		<if>
			<!-- on package no timestamp -->
			<equals arg1="${versionFound}" arg2="__BUMP_VERSION__" />
			<then>
				<property name="versionFound" value="${build.version}"  override="true" />
				<echo msg="   versionFound replaced: ${versionFound}" />
			</then>
		</if>

		<!-- add build number to version  ................................. -->

		<lib_versionWithBuildNumber result="versionWithBuild" version="${versionFound}" buildNumber="${newBuildNbr}" />
		<echo msg="versionWithBuild: ${versionWithBuild}" />

		<!--  write changed version back  ................................. -->

		<reflexive>
			<fileset dir="${buildDirTemp}">
				<include pattern="${dstManifestFileName}" />
			</fileset>
			<filterchain>
				<replaceregexp>
					<regexp pattern="(?&lt;=&lt;version&gt;).*(?=&lt;)" replace="${versionWithBuild}"/>
				</replaceregexp>
			</filterchain>
		</reflexive>

		<echo msg="      versionWithBuildNumber end" />
	</target>

	<!--
	.........................................................................
	copy2Temp
	.........................................................................
	-->

	<target name="copy2Temp">
		<echo msg="copy2Temp start" />

		<!--Copy admin files to tmp folder -->
		<copy todir="${dstAdminCmp}">
			<fileset refid="adminSet" />
		</copy>
		<!-- Copy site files -->
		<copy todir="${dstSiteCmp}">
			<fileset refid="siteSet" />
		</copy>
		<!-- Copy media files -->
		<copy todir="${dstMediaCmp}">
			<fileset refid="mediaSet" />
		</copy>

		<!-- Copy the root admin files manifest.xml, install....php-->

		<!-- <copy file="${srcAdminCmp}${comp_name}.xml" tofile="${buildDirTemp}${comp_name}.xml" />-->
		<copy file="${dstAdminManifestFile}" tofile="${dstManifestFile}" overwrite="true" />

		<copy file="${srcAdminCmp}changelog.xml" tofile="${buildDirTemp}changelog.xml" overwrite="true" />
		<copy file="${srcAdminCmp}install_rsg2.php" tofile="${buildDirTemp}install_rsg2.php" overwrite="true" />
		<copy file="${srcAdminCmp}config.xml" tofile="${buildDirTemp}config.xml" overwrite="true" />
		<copy file="${srcRoot}/LICENSE.txt" tofile="${buildDirTemp}LICENSE.txt" overwrite="true" />

		<echo msg="Copy was successful" />

		<echo msg="copy2Temp end" />
	</target>

	<!--
	.........................................................................
	doPatchComponent
	.........................................................................
	ToDo: Exchange things like date, copyrght and others (?
	-->

	<target name="doPatchComponent" >
		<echo msg="mod:doPatchComponent start" />

		<!-- dmion , comp, media -->
		<!-- <echo msg="   srcModulesCmp='${srcModulesCmp}'" />-->

		<!--		-->
		<!--		reflective .... -->
		<!--		<loadfile property="version" file="${dstManifestFile}" />-->
		<!--		<echo message="manifest version = ${version}" />-->


		<echo msg="mod:doPatchComponent done" />
	</target>

	<!--
	.........................................................................
	zipFiles
	.........................................................................
	-->

	<target name="zipFiles">
		<echo msg="zipFiles start" />

		<echo msg="   buildDirTemp='${buildDirTemp}'" />

		<!-- ++++++++++++++++++++++++++++++++++++++++++++++++++++++ -->

		<if>
			<!-- on package no timestamp -->
			<equals arg1="${isNoDateInZipName}" arg2="1" />
			<then>
				<echo message="zip: No timestamp" />
				<!-- on package no timestamp -->
				<if>
					<equals arg1="${isCalledByPackage}" arg2="0" />
					<then>
						<echo msg="    direct call" />
<!--						<property name="destfile" value="${buildDir}/${comp_name}_${type}.zip" override="true" />-->
						<property name="destfile" value="${buildDir}/${comp_name}.zip" override="true" />
					</then>
					<else>
<!--						<property name="destfile" value="${buildPackageDir}/${comp_name}_${type}.zip" override="true" />-->
						<property name="destfile" value="${buildPackageDir}/${comp_name}.zip" override="true" />
					</else>
				</if>
			</then>
			<else>
				<echo message="zip: No timestamp" />
<!--				<property name="destfile" value="${buildDir}/${comp_name}_${type}.${build.postfix}${build.version}_${dateYearMonthDay}.zip" override="true" />-->
				<property name="destfile" value="${buildDir}/${comp_name}.${build.postfix}${build.version}_${dateYearMonthDay}.zip" override="true" />
			</else>
		</if>

		<echo msg="destfile='${destfile}'" />

		<zip destfile="${destfile}">
			<fileset dir="${buildDirTemp}">
				<include name="**" />
			</fileset>
		</zip>

		<echo msg="zipFiles end" />
	</target>


</project>
